# 標準入出力のインタラクションモード

## 概要

nospace プログラムの標準入力（stdin）と標準出力（stdout/stderr）を扱う 2 つのモードを提供する。

## モード一覧

### 1. Batch モード（テキスト入力）

```
+----------------------------------+
|  標準入力 (batch)                 |
|  +------------------------------+|
|  | テキストエリア                 ||
|  | (複数行入力可能)               ||
|  |                               ||
|  +------------------------------+|
+----------------------------------+
```

- **実行前** にテキストエリアに全入力を記述
- 実行時にテキスト全体がプロセスの stdin に一括送信される
- stdin 送信後、プロセス側の stdin は EOF になる
- I/O を多用しないプログラムの動作確認に適する

#### 実装

- `nospace_run` イベントの payload に `stdinData` フィールドを追加
- サーバー側: プロセス起動直後に `stdinData` を `process.stdin.write()` → `process.stdin.end()`

```typescript
// RunOptions に追加
export interface RunPayload {
  code: string;
  options: RunOptions;
  stdinData?: string;  // batch モード時のみ
}
```

### 2. Interactive モード（リアルタイム入力）

```
+----------------------------------+
|  標準出力                         |
|  +------------------------------+|
|  | Hello!                        ||
|  | Enter a number:               ||
|  |                               ||
|  +------------------------------+|
|                                   |
|  標準入力 (interactive)           |
|  +------------------------+ [⏎] |
|  | _                      |      |
|  +------------------------+      |
+----------------------------------+
```

- プログラム実行中にリアルタイムで入力を送信
- 1 行入力 + Enter（送信ボタン or Enter キー）で送信
- 送信時に改行文字 `\n` を末尾に付与してプロセスの stdin に書き込み
- 送信した入力は stdout エリアにも「エコー」表示（区別のためスタイルを変える）
- I/O を多用するインタラクティブなプログラムに適する

#### 実装

- `nospace_stdin` イベントで逐次送信
- 入力フィールドは送信後にクリア
- 入力履歴（↑↓キーで過去の入力を呼び出し）は将来対応でも良い

## OutputPanel の設計

### 表示ルール

- stdout と stderr は **時系列順に混在表示** する（別パネルではなく同一パネル）
- stderr は赤色など異なるスタイルで表示し区別
- interactive モードの stdin エコーは灰色/イタリック等で表示

### データ構造

```typescript
export type OutputEntry = {
  type: 'stdout' | 'stderr' | 'stdin-echo' | 'system';
  data: string;
  timestamp: number;
};

// executionAtom.ts
export const outputEntriesAtom = atom<OutputEntry[]>([]);
```

- `system` タイプ: 「プロセス開始」「プロセス終了 (exit code: 0)」等のシステムメッセージ

### 表示の最適化

- 出力が大量になった場合のパフォーマンス対策
- 表示上限: 最新 10000 行（古い行は切り捨て）
- 自動スクロール: デフォルトで有効、ユーザーが上にスクロールすると停止、最下部に戻ると再開
- 仮想スクロールは初期実装では不要（必要になったら導入）

### クリア

- 「Clear」ボタンで出力をクリア
- 新しい実行を開始した際にも自動クリア

## モード切り替え

- `ExecutionOptions` の `inputMode` で切り替え
- 実行中でもモード切り替えは可能（ただし batch → interactive は stdin が既に EOF なので実質意味なし）
- UI 上はラジオボタンまたはトグルで切り替え

## 将来拡張

- PTY（擬似端末）対応: `node-pty` を使ってより本格的なターミナルエミュレーション
- xterm.js の導入: ターミナル風の表示
- 入力履歴・補完
